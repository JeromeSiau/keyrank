# 6.3 Chat with Executable Actions

## Overview

Extend the existing AI Chat to execute real actions based on user requests using **LLM Tool Calling**. The assistant will use native function calling to propose actions, present confirmation cards, and execute approved actions.

## User Stories

- **US-15.1**: User can ask the AI to add a keyword to tracking via natural language
- **US-15.2**: User can ask the AI to create an alert with natural language descriptions
- **US-15.3**: User can ask the AI to update metadata after explicit confirmation

## Supported Tools

| Tool | Description | Parameters |
|------|-------------|------------|
| `add_keywords` | Add keyword(s) to tracking | keywords[], country? |
| `remove_keywords` | Remove keyword(s) from tracking | keywords[] |
| `create_alert` | Create an alert rule | keyword, condition, threshold, channels[] |
| `update_metadata` | Update app metadata | field, value, locale? |
| `add_competitor` | Add a competitor to track | app_name or app_id |
| `export_data` | Export data to CSV | type (keywords/analytics/reviews), date_range? |

## Architecture

### Action Flow (Using Tool Calling)

```
1. User sends message â†’ "Add 'budget planner' to my keywords"
2. ChatService sends message to LLM with tool definitions
3. LLM returns { content: "...", tool_calls: [...] }
4. Backend creates ChatAction record(s) with status=proposed
5. Backend returns message with actions array
6. Flutter displays action confirmation cards
7. User confirms/cancels action
8. If confirmed â†’ POST /chat/actions/{id}/execute
9. ActionExecutorService executes the action
10. Result stored, UI updated
```

### Key Design Decisions

1. **Native Tool Calling** - Uses OpenRouter/OpenAI function calling (robust, multilingual)
2. **Explicit confirmation required** - All actions need user approval before execution
3. **Multiple actions per message** - LLM can return multiple tool_calls
4. **Action state tracking** - proposed â†’ confirmed/cancelled â†’ executed/failed

---

## Implementation Plan

### Task 1: Backend - Migration & ChatAction Model âœ…

**Files to create:**
- `api/app/Models/ChatAction.php` âœ…
- `api/database/migrations/2026_01_16_300000_create_chat_actions_table.php` âœ…

**Verification:** Run `php artisan migrate` successfully

---

### Task 2: Backend - OpenRouterService Tool Calling

**Files to modify:**
- `api/app/Services/OpenRouterService.php`

**Add new method with tool calling support:**

```php
public function chatWithTools(
    string $systemPrompt,
    array $messages,
    array $tools = [],
): array {
    $payload = [
        'model' => $this->model,
        'messages' => array_merge(
            [['role' => 'system', 'content' => $systemPrompt]],
            $messages
        ),
    ];

    if (!empty($tools)) {
        $payload['tools'] = $tools;
        $payload['tool_choice'] = 'auto';
    }

    // ... API call ...

    return [
        'content' => $response->json('choices.0.message.content'),
        'tool_calls' => $response->json('choices.0.message.tool_calls') ?? [],
        'tokens_used' => $response->json('usage.total_tokens') ?? 0,
    ];
}
```

**Add tool definitions:**

```php
public static function getActionTools(): array
{
    return [
        [
            'type' => 'function',
            'function' => [
                'name' => 'add_keywords',
                'description' => 'Add keywords to tracking for the current app. Use when user wants to track new keywords.',
                'parameters' => [
                    'type' => 'object',
                    'properties' => [
                        'keywords' => [
                            'type' => 'array',
                            'items' => ['type' => 'string'],
                            'description' => 'List of keywords to add',
                        ],
                        'country' => [
                            'type' => 'string',
                            'description' => 'Country code (default: US)',
                        ],
                    ],
                    'required' => ['keywords'],
                ],
            ],
        ],
        [
            'type' => 'function',
            'function' => [
                'name' => 'remove_keywords',
                'description' => 'Remove keywords from tracking. Use when user wants to stop tracking keywords.',
                'parameters' => [
                    'type' => 'object',
                    'properties' => [
                        'keywords' => [
                            'type' => 'array',
                            'items' => ['type' => 'string'],
                            'description' => 'List of keywords to remove',
                        ],
                    ],
                    'required' => ['keywords'],
                ],
            ],
        ],
        [
            'type' => 'function',
            'function' => [
                'name' => 'create_alert',
                'description' => 'Create an alert rule for keyword ranking changes.',
                'parameters' => [
                    'type' => 'object',
                    'properties' => [
                        'keyword' => ['type' => 'string', 'description' => 'Keyword to monitor'],
                        'condition' => ['type' => 'string', 'enum' => ['reaches_top', 'drops_below', 'improves_by', 'drops_by']],
                        'threshold' => ['type' => 'integer', 'description' => 'Position threshold (e.g., 10 for top 10)'],
                        'channels' => [
                            'type' => 'array',
                            'items' => ['type' => 'string', 'enum' => ['push', 'email']],
                            'description' => 'Notification channels',
                        ],
                    ],
                    'required' => ['keyword', 'condition', 'threshold'],
                ],
            ],
        ],
        [
            'type' => 'function',
            'function' => [
                'name' => 'add_competitor',
                'description' => 'Add a competitor app to track.',
                'parameters' => [
                    'type' => 'object',
                    'properties' => [
                        'app_name' => ['type' => 'string', 'description' => 'Name of the competitor app'],
                        'store' => ['type' => 'string', 'enum' => ['ios', 'android'], 'description' => 'App store'],
                    ],
                    'required' => ['app_name'],
                ],
            ],
        ],
        [
            'type' => 'function',
            'function' => [
                'name' => 'export_data',
                'description' => 'Export app data to CSV file.',
                'parameters' => [
                    'type' => 'object',
                    'properties' => [
                        'type' => ['type' => 'string', 'enum' => ['keywords', 'analytics', 'reviews']],
                        'date_range' => ['type' => 'string', 'enum' => ['7d', '30d', '90d', 'all']],
                    ],
                    'required' => ['type'],
                ],
            ],
        ],
    ];
}
```

**Verification:** API call with tools returns tool_calls when user asks for an action

---

### Task 3: Backend - ChatService Integration & ActionExecutorService

**Files to create:**
- `api/app/Services/ActionExecutorService.php`

**Files to modify:**
- `api/app/Services/ChatService.php`
- `api/app/Http/Controllers/Api/ChatController.php`
- `api/routes/api.php`

#### 3.1 ChatService - Process tool calls

Update `ask()` method to:
1. Call `chatWithTools()` instead of `chat()`
2. If tool_calls returned, create ChatAction records
3. Include actions in response

```php
// In ChatService::ask()
$response = $this->openRouter->chatWithTools(
    $systemPrompt,
    $formattedMessages,
    OpenRouterService::getActionTools()
);

// Process tool calls
$actions = [];
foreach ($response['tool_calls'] ?? [] as $toolCall) {
    $action = ChatAction::create([
        'message_id' => $assistantMessage->id,
        'type' => $toolCall['function']['name'],
        'parameters' => json_decode($toolCall['function']['arguments'], true),
        'status' => 'proposed',
        'explanation' => $this->generateActionExplanation($toolCall),
        'reversible' => $this->isReversible($toolCall['function']['name']),
    ]);
    $actions[] = $action;
}
```

#### 3.2 ActionExecutorService

```php
class ActionExecutorService
{
    public function __construct(
        private KeywordRepository $keywords,
        private AlertRepository $alerts,
        private CompetitorRepository $competitors,
        private CsvExporter $exporter,
    ) {}

    public function execute(ChatAction $action, App $app, User $user): array
    {
        return match($action->type) {
            'add_keywords' => $this->addKeywords($action, $app),
            'remove_keywords' => $this->removeKeywords($action, $app),
            'create_alert' => $this->createAlert($action, $app, $user),
            'add_competitor' => $this->addCompetitor($action, $app),
            'export_data' => $this->exportData($action, $app),
            default => throw new \InvalidArgumentException("Unknown action: {$action->type}"),
        };
    }

    private function addKeywords(ChatAction $action, App $app): array
    {
        $keywords = $action->parameters['keywords'];
        $country = $action->parameters['country'] ?? 'US';
        $added = [];

        foreach ($keywords as $keyword) {
            // Use existing keyword creation logic
            $added[] = $this->keywords->addKeyword($app, $keyword, $country);
        }

        return [
            'success' => true,
            'added_count' => count($added),
            'keywords' => $added,
        ];
    }

    // ... other action implementations
}
```

#### 3.3 New endpoints

```php
// routes/api.php
Route::post('/chat/actions/{action}/execute', [ChatController::class, 'executeAction']);
Route::post('/chat/actions/{action}/cancel', [ChatController::class, 'cancelAction']);

// ChatController
public function executeAction(ChatAction $action)
{
    $this->authorize('execute', $action);

    if (!$action->canExecute()) {
        return response()->json(['error' => 'Action cannot be executed'], 400);
    }

    try {
        $app = $action->message->conversation->app;
        $result = $this->actionExecutor->execute($action, $app, auth()->user());
        $action->markAsExecuted($result);

        return response()->json([
            'success' => true,
            'result' => $result,
        ]);
    } catch (\Exception $e) {
        $action->markAsFailed($e->getMessage());
        return response()->json(['error' => $e->getMessage()], 500);
    }
}
```

**Verification:** Send "add budget planner to my keywords" and receive action in response

---

### Task 4: Flutter - Action Models

**Files to create:**
- `app/lib/features/chat/domain/chat_action_model.dart`

```dart
import 'package:freezed_annotation/freezed_annotation.dart';

part 'chat_action_model.freezed.dart';
part 'chat_action_model.g.dart';

@freezed
class ChatAction with _$ChatAction {
  const factory ChatAction({
    required int id,
    required String type,
    required Map<String, dynamic> parameters,
    required String status,
    required String explanation,
    @Default(true) bool reversible,
    Map<String, dynamic>? result,
  }) = _ChatAction;

  factory ChatAction.fromJson(Map<String, dynamic> json) =>
      _$ChatActionFromJson(json);
}

extension ChatActionX on ChatAction {
  bool get isProposed => status == 'proposed';
  bool get isExecuted => status == 'executed';
  bool get isCancelled => status == 'cancelled';
  bool get isFailed => status == 'failed';
  bool get canExecute => status == 'proposed';

  String get displayName => switch (type) {
    'add_keywords' => 'Add Keywords',
    'remove_keywords' => 'Remove Keywords',
    'create_alert' => 'Create Alert',
    'add_competitor' => 'Add Competitor',
    'export_data' => 'Export Data',
    _ => type,
  };

  String get icon => switch (type) {
    'add_keywords' => 'ðŸŽ¯',
    'remove_keywords' => 'ðŸ—‘ï¸',
    'create_alert' => 'ðŸ””',
    'add_competitor' => 'ðŸ‘€',
    'export_data' => 'ðŸ“¥',
    _ => 'âš¡',
  };
}
```

**Verification:** Run `dart run build_runner build`

---

### Task 5: Flutter - Update ChatMessage & Repository

**Files to modify:**
- `app/lib/features/chat/domain/chat_models.dart` - Add actions to ChatMessage
- `app/lib/features/chat/data/chat_repository.dart` - Add execute/cancel methods

**Verification:** Compile without errors

---

### Task 6: Flutter - ActionCard Widget

**Files to create:**
- `app/lib/features/chat/presentation/widgets/action_card.dart`

UI for different action types with Confirm/Cancel buttons, loading state, success/error display.

**Verification:** Widget renders with sample data

---

### Task 7: Flutter - Integrate Actions into MessageBubble

**Files to modify:**
- `app/lib/features/chat/presentation/widgets/message_bubble.dart`

Render ActionCard for each action in the message.

**Verification:** Action cards appear in chat

---

### Task 8: Flutter - Action Execution Flow & Provider Updates

**Files to modify:**
- `app/lib/features/chat/providers/chat_provider.dart`
- `app/lib/features/chat/presentation/chat_conversation_screen.dart`

Handle action execution, loading states, and results.

**Verification:** Execute action from UI successfully

---

### Task 9: Localization

**Files to modify:**
- `app/lib/l10n/app_en.arb`
- `app/lib/l10n/app_fr.arb`

**Verification:** Strings display correctly in both languages

---

## Files Summary

### New Files
- `api/app/Models/ChatAction.php` âœ…
- `api/database/migrations/2026_01_16_300000_create_chat_actions_table.php` âœ…
- `api/app/Services/ActionExecutorService.php`
- `app/lib/features/chat/domain/chat_action_model.dart`
- `app/lib/features/chat/presentation/widgets/action_card.dart`

### Modified Files
- `api/app/Services/OpenRouterService.php` - Add chatWithTools()
- `api/app/Services/ChatService.php` - Process tool_calls
- `api/app/Http/Controllers/Api/ChatController.php` - Add execute/cancel endpoints
- `api/routes/api.php` - Add action routes
- `app/lib/features/chat/domain/chat_models.dart` - Add actions to ChatMessage
- `app/lib/features/chat/data/chat_repository.dart` - Add action methods
- `app/lib/features/chat/providers/chat_provider.dart` - Handle action state
- `app/lib/features/chat/presentation/widgets/message_bubble.dart` - Render actions
- `app/lib/l10n/app_en.arb` & `app_fr.arb` - Action strings
