# 5.6 Conversion Funnel Analytics - Implementation Plan

**Date**: 2026-01-16
**Status**: Ready for Implementation
**Estimated Tasks**: 9 tasks

---

## Overview

Implement a conversion funnel visualization showing:
- **Impressions** â†’ **Product Page Views** â†’ **Downloads**
- Source attribution (Search, Browse, Referrals, App Ads)
- Comparison to category average
- Historical trend analysis

---

## Task Breakdown

### Task 1: Backend - Create Migration for Funnel Analytics Table

**Files to create:**
- `api/database/migrations/2026_01_16_200000_create_app_funnel_analytics_table.php`

**Schema:**
```php
Schema::create('app_funnel_analytics', function (Blueprint $table) {
    $table->id();
    $table->foreignId('app_id')->constrained()->onDelete('cascade');
    $table->date('date');
    $table->string('country_code', 2)->default('WW');
    $table->string('source')->default('total'); // search, browse, referral, app_referrer, web_referrer, total
    $table->integer('impressions')->default(0);
    $table->integer('impressions_unique')->default(0);
    $table->integer('page_views')->default(0);
    $table->integer('page_views_unique')->default(0);
    $table->integer('downloads')->default(0);
    $table->integer('first_time_downloads')->default(0);
    $table->integer('redownloads')->default(0);
    $table->decimal('conversion_rate', 5, 2)->nullable(); // impressions to downloads
    $table->timestamps();

    $table->unique(['app_id', 'date', 'country_code', 'source']);
    $table->index(['app_id', 'date']);
});
```

**Verification:** Run `php artisan migrate` successfully

---

### Task 2: Backend - Create AppFunnelAnalytics Model

**Files to create:**
- `api/app/Models/AppFunnelAnalytics.php`

**Features:**
- Belongs to App relationship
- Scopes: `forPeriod($start, $end)`, `bySource($source)`, `byCountry($country)`
- Computed conversion rates
- Aggregation methods

**Verification:** Model can query the table

---

### Task 3: Backend - Extend AppStoreConnectService for Analytics API

**Files to modify:**
- `api/app/Services/AppStoreConnectService.php`

**Methods to add:**
```php
public function requestAnalyticsReport(StoreConnection $connection, string $appId, string $accessType = 'ONGOING'): ?string
public function getAnalyticsReportInstances(StoreConnection $connection, string $reportRequestId, string $category = 'APP_STORE_ENGAGEMENT'): ?array
public function downloadAnalyticsReport(StoreConnection $connection, string $instanceId): ?array
public function getConversionFunnelData(StoreConnection $connection, string $appId, string $startDate, string $endDate): ?array
```

**API Flow:**
1. POST `/v1/analyticsReportRequests` with app relationship and accessType
2. GET `/v1/analyticsReportRequests/{id}/reports?filter[category]=APP_STORE_ENGAGEMENT`
3. GET `/v1/analyticsReports/{id}/instances`
4. GET `/v1/analyticsReportInstances/{id}/segments`
5. Download and parse gzipped report data

**Verification:** Can fetch sample analytics data from ASC

---

### Task 4: Backend - Extend GooglePlayDeveloperService for Funnel Data

**Files to modify:**
- `api/app/Services/GooglePlayDeveloperService.php`

**Methods to add:**
```php
public function getAcquisitionReport(StoreConnection $connection, int $year, int $month): ?array
public function getConversionFunnelData(StoreConnection $connection, string $packageName, string $startDate, string $endDate): ?array
```

**Data sources:**
- Store listing acquisition report (impressions, visitors)
- Installs report (downloads by source)

**Verification:** Can fetch sample acquisition data from Google Play

---

### Task 5: Backend - Create FunnelController with API Endpoint

**Files to create:**
- `api/app/Http/Controllers/Api/FunnelController.php`

**Files to modify:**
- `api/routes/api.php` - Add funnel routes

**Endpoints:**
```php
// Get funnel data for an app
GET /api/apps/{app}/funnel?period=30d&country=all&source=all

// Response format:
{
    "summary": {
        "impressions": 125430,
        "page_views": 23891,
        "downloads": 4521,
        "impression_to_page_view_rate": 19.0,
        "page_view_to_download_rate": 18.9,
        "overall_conversion_rate": 3.6,
        "category_average": 2.9,
        "vs_category": "+24%"
    },
    "by_source": [
        {
            "source": "search",
            "source_label": "App Store Search",
            "impressions": 77767,
            "page_views": 16712,
            "downloads": 3729,
            "conversion_rate": 4.8,
            "percentage_of_total": 82.5
        },
        // ... browse, referral, app_ads
    ],
    "trend": [
        {
            "date": "2026-01-09",
            "impressions": 4500,
            "page_views": 850,
            "downloads": 160,
            "conversion_rate": 3.6
        },
        // ... daily data points
    ],
    "comparison": {
        "previous_period": {
            "impressions_change": 12.5,
            "page_views_change": 8.3,
            "downloads_change": 15.2,
            "conversion_rate_change": 0.4
        }
    }
}
```

**Verification:** API endpoint returns structured funnel data

---

### Task 6: Backend - Create Job to Sync Funnel Analytics

**Files to create:**
- `api/app/Jobs/SyncFunnelAnalyticsJob.php`

**Files to modify:**
- `api/app/Console/Kernel.php` - Schedule daily sync

**Features:**
- Sync data for all apps with store connections
- Handle iOS and Android differently
- Store in `app_funnel_analytics` table
- Handle 24-48h reporting delay from stores

**Schedule:** Daily at 05:00 UTC (after other analytics sync)

**Verification:** Job runs and populates funnel data

---

### Task 7: Flutter - Create Funnel Models

**Files to create:**
- `app/lib/features/analytics/domain/conversion_funnel_model.dart`

**Models (Freezed):**
```dart
@freezed
class ConversionFunnel with _$ConversionFunnel {
  const factory ConversionFunnel({
    required FunnelSummary summary,
    required List<SourceConversion> bySource,
    required List<FunnelDataPoint> trend,
    required FunnelComparison comparison,
  }) = _ConversionFunnel;

  factory ConversionFunnel.fromJson(Map<String, dynamic> json) => _$ConversionFunnelFromJson(json);
}

@freezed
class FunnelSummary with _$FunnelSummary {
  const factory FunnelSummary({
    required int impressions,
    required int pageViews,
    required int downloads,
    required double impressionToPageViewRate,
    required double pageViewToDownloadRate,
    required double overallConversionRate,
    double? categoryAverage,
    String? vsCategory,
  }) = _FunnelSummary;
}

@freezed
class SourceConversion with _$SourceConversion {
  const factory SourceConversion({
    required String source,
    required String sourceLabel,
    required int impressions,
    required int pageViews,
    required int downloads,
    required double conversionRate,
    required double percentageOfTotal,
  }) = _SourceConversion;
}

@freezed
class FunnelDataPoint with _$FunnelDataPoint {
  const factory FunnelDataPoint({
    required DateTime date,
    required int impressions,
    required int pageViews,
    required int downloads,
    required double conversionRate,
  }) = _FunnelDataPoint;
}

@freezed
class FunnelComparison with _$FunnelComparison {
  const factory FunnelComparison({
    required double impressionsChange,
    required double pageViewsChange,
    required double downloadsChange,
    required double conversionRateChange,
  }) = _FunnelComparison;
}
```

**Verification:** Run `dart run build_runner build` successfully

---

### Task 8: Flutter - Add Repository and Providers

**Files to modify:**
- `app/lib/features/analytics/data/analytics_repository.dart`
- `app/lib/features/analytics/providers/analytics_provider.dart`

**Repository method:**
```dart
Future<ConversionFunnel> getFunnel({
  required int appId,
  required String period,
  String? country,
  String? source,
});
```

**Providers:**
```dart
final funnelSourceFilterProvider = StateProvider<String?>((ref) => null);
final funnelCountryFilterProvider = StateProvider<String?>((ref) => null);

final conversionFunnelProvider = FutureProvider.autoDispose.family<ConversionFunnel, int>((ref, appId) async {
  final repository = ref.watch(analyticsRepositoryProvider);
  final period = ref.watch(analyticsPeriodProvider);
  final source = ref.watch(funnelSourceFilterProvider);
  final country = ref.watch(funnelCountryFilterProvider);

  return repository.getFunnel(
    appId: appId,
    period: period,
    source: source,
    country: country,
  );
});
```

**Verification:** Provider can fetch and cache funnel data

---

### Task 9: Flutter - Create Funnel UI Components

**Files to create:**
- `app/lib/features/analytics/presentation/widgets/conversion_funnel_card.dart`
- `app/lib/features/analytics/presentation/widgets/funnel_source_breakdown.dart`
- `app/lib/features/analytics/presentation/widgets/funnel_trend_chart.dart`

**Files to modify:**
- `app/lib/features/analytics/presentation/screens/app_analytics_screen.dart` - Add Funnel tab
- `app/lib/l10n/app_en.arb` - Add l10n strings
- `app/lib/l10n/app_fr.arb` - Add l10n strings

**UI Components:**

**1. ConversionFunnelCard** - Visual funnel with stages:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IMPRESSIONS           PAGE VIEWS            DOWNLOADS      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  125,430  â”‚   â†’    â”‚   23,891  â”‚   â†’    â”‚   4,521   â”‚   â”‚
â”‚  â”‚           â”‚        â”‚   19.0%   â”‚        â”‚   18.9%   â”‚   â”‚
â”‚  â”‚           â”‚        â”‚  â†‘ 2.3%   â”‚        â”‚  â†“ 0.8%   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Overall CVR: 3.6%  |  Category avg: 2.9%  âœ… +24%          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2. FunnelSourceBreakdown** - Table with source performance:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source     â”‚ Impressions â”‚ Page Views â”‚ Downloads â”‚  CVR   â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ” Search  â”‚    77,767   â”‚   16,712   â”‚   3,729   â”‚  4.8%  â”‚
â”‚ ğŸ“‚ Browse  â”‚    22,577   â”‚    3,823   â”‚     452   â”‚  2.0%  â”‚
â”‚ ğŸ”— Referralâ”‚    13,797   â”‚    2,159   â”‚     271   â”‚  2.0%  â”‚
â”‚ ğŸ“¢ App Ads â”‚    11,289   â”‚    1,197   â”‚      69   â”‚  0.6%  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3. FunnelTrendChart** - Line chart showing CVR over time with fl_chart

**l10n strings to add:**
- `funnelTitle`: "Conversion Funnel"
- `funnelImpressions`: "Impressions"
- `funnelPageViews`: "Page Views"
- `funnelDownloads`: "Downloads"
- `funnelOverallCvr`: "Overall CVR"
- `funnelCategoryAvg`: "Category avg"
- `funnelVsCategory`: "vs category"
- `funnelSourceSearch`: "App Store Search"
- `funnelSourceBrowse`: "Browse"
- `funnelSourceReferral`: "Referrals"
- `funnelSourceAppAds`: "App Ads"
- `funnelTrend`: "Conversion Trend"
- `funnelBySource`: "By Source"
- `funnelInsight`: "Search traffic converts {rate}x better than Browse"

**Verification:** UI renders with mock/real data, responsive design works

---

## Execution Order

```
Task 1 (Migration) â†’ Task 2 (Model) â†’ Task 3 (ASC Service) â†’ Task 4 (Google Play Service)
                                                    â†“
Task 5 (Controller) â†’ Task 6 (Sync Job) â†’ Task 7 (Flutter Models) â†’ Task 8 (Providers) â†’ Task 9 (UI)
```

**Batch 1:** Tasks 1-3 (Backend foundation + iOS API)
**Batch 2:** Tasks 4-6 (Android API + Controller + Job)
**Batch 3:** Tasks 7-9 (Flutter implementation)

---

## Dependencies

- Existing `App` model and relationships
- Existing `StoreConnection` model for API credentials
- Existing `analyticsPeriodProvider` for period selection
- fl_chart package (already installed)
- App Store Connect API key with Analytics permission

---

## Testing Notes

1. **Backend**: Test with real App Store Connect credentials to verify Analytics API access
2. **Data Delay**: Analytics data has 24-48h delay from stores
3. **Empty State**: Handle apps without analytics data gracefully
4. **iOS vs Android**: Show appropriate data based on app platform

---

## Rollback Plan

If Analytics API access fails:
1. Show "Coming Soon" message for funnel
2. Display downloads-only data from existing `app_analytics` table
3. Add manual CSV import option as fallback
